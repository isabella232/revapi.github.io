
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2019-05-06
 Rendered using Msb3 Maven Skin 0.1.1 (http://tunguski.github.io/msb3-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Revapi Java SPI - Revapi Java SPI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://bootswatch.com/3/cosmo/bootstrap.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/msb3-skin.css" rel="stylesheet" />

		<link href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/default.min.css" rel="stylesheet" />

		<link href="./css/lightbox.css" rel="stylesheet" />

		<link href="./css/site.css" rel="stylesheet" />

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->


		
	</head>

	<body class="page-index project-revapi-java-spi" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<header class="navbar navbar-default navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<a class="navbar-toggle collapsed" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="navbar-brand" href="../..">Revapi</a>
				</div>
					<div class="collapse navbar-collapse" id="top-nav-collapse">
						<ul class="nav navbar-nav navbar-right">
							<li ><a href="https://diff.revapi.org" title="Online Check" class="externalLink">Online Check</a></li>
							<li ><a href="../../news.html" title="News">News</a></li>
							<li ><a href="../../getting-started.html" title="Getting Started">Getting Started</a></li>
							<li ><a href="../../downloads.html" title="Downloads">Downloads</a></li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Basic Info <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="../../architecture.html" title="Architecture">Architecture</a></li>
									<li ><a href="../../configuration.html" title="Configuration">Configuration</a></li>
									<li ><a href="../../building.html" title="Building">Building</a></li>
									<li ><a href="../../extensions.html" title="Extensions">Extensions</a></li>
								</ul>
							</li>
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Sub Projects <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="../revapi/index.html" title="Revapi API">Revapi API</a></li>
									<li ><a href="../revapi-ant-task/index.html" title="Ant Task">Ant Task</a></li>
									<li ><a href="../revapi-basic-features/index.html" title="Basic Features">Basic Features</a></li>
									<li ><a href="../revapi-java/index.html" title="Java Extension">Java Extension</a></li>
									<li class="active"><a href="" title="Java Extension SPI">Java Extension SPI</a></li>
									<li ><a href="https://github.com/revapi/testjars" title="Java Test Support" class="externalLink">Java Test Support</a></li>
									<li ><a href="../revapi-reporter-text/index.html" title="Text Report Extension">Text Report Extension</a></li>
									<li ><a href="../revapi-maven-plugin/index.html" title="Maven Plugin">Maven Plugin</a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
			</div>
		</header>

	<div class="container">

	<!-- Masthead
	================================================== -->

	<header>
	<div class="jumbotron">
		<div class="row">
			<div class="col-md-12">
				<div class="pull-left">
					<a href="https://revapi.org/modules/revapi-java-spi" id="bannerLeft"><h1>Revapi Java SPI</h1></a>
					<p class="lead">SPI for extending the java extension of Revapi.</p>
				</div>
				<div class="pull-right">
				</div>
			</div>
		</div>
	</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="col-md-8">
			<div class="body-content">
<div class="sect1"> 
 <div class="page-header">
  <h2 id="revapi_java_spi">Revapi Java SPI</h2>
 </div> 
 <div class="sectionbody"> 
  <div class="paragraph"> 
   <p>The SPI of the Revapi’s Java extension exists so that other extensions can take advantage of the capabilities of the java extension - namely to analyze the java classes. The most interesting part of this section is therefore the <a href="apidocs/index.html">javadoc</a> of the SPI.</p> 
  </div> 
  <div class="paragraph"> 
   <p>The below two examples show the two major extension points of Revapi’s Java checker: * the ability to define new checks * the ability to extract class files from custom archives</p> 
  </div> 
 </div> 
</div> 
<div class="sect1"> 
 <h2 id="enhancing_java_api_checks">Enhancing Java API checks</h2> 
 <div class="sectionbody"> 
  <div class="paragraph"> 
   <p>In this example it will be shown how to extend the Revapi’s java API checking capabilities. We will use the <a href="apidocs/org/revapi/java/spi/Check.html">hook interface</a> into the java checking process that represents the Revapi’s API elements as Java’s own <a href="http://docs.oracle.com/javase/7/docs/api/javax/lang/model/package-summary.html">model elements</a>.</p> 
  </div> 
  <div class="paragraph"> 
   <p>The checking framework then can use the Java plaform’s own rich functionality for examining the classes in the checked libraries (note, that this API is NOT the reflection API, because it actually doesn’t load the library classes into Java runtime).</p> 
  </div> 
  <div class="paragraph"> 
   <p>To make it actually useful, this example will show how to automatically ignore addition of any new methods on the EJB interfaces. While a new method on an interface is generally an API breakage, because the implementations that were developed against the old version of the interface would no longer be valid, this change is actually OK on EJB interfaces, because these are not supposed to be implemented by "callers" - the implementations are in control of the library that defines the EJBs.</p> 
  </div> 
  <div class="sect2"> 
   <h3 id="project_setup">Project setup</h3> 
   <div class="paragraph"> 
    <p>First we need to set up our maven project. We will be extending Revapi’s Java extension that offers an SPI for doing so. In the <code>pom.xml</code>, we will specify that we want to use that SPI:</p> 
   </div> 
   <div class="listingblock"> 
    <div class="content"> 
     <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;project&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;my.group&lt;/groupId&gt;
    &lt;artifactId&gt;my.extension&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.revapi&lt;/groupId&gt;
            &lt;artifactId&gt;revapi-java-spi&lt;/artifactId&gt;
            &lt;version&gt;{version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;</code></pre> 
    </div> 
   </div> 
  </div> 
  <div class="sect2"> 
   <h3 id="code">Code</h3> 
   <div class="paragraph"> 
    <p>To ignore a found difference, we need to implement a <a href="../revapi/apidocs/org/revapi/DifferenceTransform.html">difference transform</a>.</p> 
   </div> 
   <div class="listingblock"> 
    <div class="content"> 
     <pre class="highlight"><code class="language-java" data-lang="java">package my.extension;

import java.io.Reader;
import java.util.regex.Pattern;

import javax.lang.model.element.AnnotationMirror;
import javax.lang.model.element.ExecutableElement;

import org.revapi.AnalysisContext;
import org.revapi.Difference;
import org.revapi.DifferenceTransform;
import org.revapi.java.spi.JavaMethodElement;
import org.revapi.java.spi.Util;

public class IgnoreNewMethodsOnEJBInterfaces implements DifferenceTransform&lt;JavaMethodElement&gt; {
    @Override
    public Pattern[] getDifferenceCodePatterns() {
        return new Pattern[] { Pattern.compile("java\\.method\\.addedToInterface") };
    }

    @Override
    public Difference transform(JavaMethodElement oldElement, JavaMethodElement newElement,
        Difference difference) {

        // we know the element will be a JavaMethodElement. This is because we limit the
        // differences passed into this method.
        ExecutableElement method = newElement.getDeclaringElement();

        // ok, so we got a reference to the method that caused the difference. Now we need to
        // check whether the method was added to an EJB interface - we will just check whether
        // the interface was annotated with the @Local or @Remote annotations.
        for (AnnotationMirror annotation : method.getEnclosingElement().getAnnotationMirrors()) {
            // the Util class in the Java SPI provides a number of useful methods to ease the work
            // with the javax.lang.model objects.
            String annotationTypeName = Util.toHumanReadableString(annotation.getAnnotationType());
            if ("javax.ejb.Local".equals(annotationTypeName) ||
                "javax.ejb.Remote".equals(annotationTypeName)) {

                // ok, so we've found out that the type that declared the new method is indeed
                // an EJB interface. By returning null, we tell Revapi to remove this difference.
                return null;
            }
        }

        // ok, this is not an EJB interface, so we leave the difference alone
        return difference;
    }

    @Override
    public void close() throws Exception {
        // no resources to close...
    }

    @Override
    public String[] getConfigurationRootPaths() {
        // no configuration possible
        return null;
    }

    @Override
    public Reader getJSONSchema(String configurationRootPath) {
        // no configuration possible
        return null;
    }

    @Override
    public void initialize(AnalysisContext analysisContext) {
        // nothing needed here
    }
}</code></pre> 
    </div> 
   </div> 
   <div class="paragraph"> 
    <p>In addition to the code itself, the class needs to be registered as an Revapi extension. For that it needs to be made a java service. Create a file called <code>src/main/resources/META-INF/services/org.revapi.DifferenceTransform</code> and add a line to it with the fully qualified name of the above class, i.e <code>my.extension.IgnoreNewMethodsOnEJBInterfaces</code>.</p> 
   </div> 
  </div> 
  <div class="sect2"> 
   <h3 id="usage">Usage</h3> 
   <div class="paragraph"> 
    <p>Once installed into a maven repository (local or some public), our extension becomes useable by Revapi. Both the Revapi standalone and maven plugin support including new extensions by specifying their maven coordinates, see <a href="../../getting-started.html">Getting Started</a> for more details on that.</p> 
   </div> 
  </div> 
 </div> 
</div> 
<div class="sect1"> 
 <h2 id="handling_new_packaging_of_code">Handling new packaging of code</h2> 
 <div class="sectionbody"> 
  <div class="paragraph"> 
   <p>Java code is not always packaged as JAR files. WAR files, Spring Boot fat JARs, etc, all re-package the code in custom ways which do not conform to or alter the default layout of a JAR file. Revapi doesn’t know where to find significant classes of those artifacts (i.e. the classes that are unique to that artifact and not brought it from dependencies) and therefore fails to properly analyze them for the API changes.</p> 
  </div> 
  <div class="paragraph"> 
   <p>Fortunately, since <code>revapi-java-spi-0.18.0</code> and <code>revapi-java-0.19.0</code>, there is a new possibility to define custom ways of extracting files from the archives, the <a href="apidocs/org/revapi/java/spi/JarExtractor.html">JarExtractor</a>.</p> 
  </div> 
  <div class="paragraph"> 
   <p>Implementations of this interface can be used to make Revapi "understand" new types of archives. Provided with an abstraction of an archive (with a name and a way to open an input stream with the data of the archive), the jar extractors are given a chance to transform the input stream of the archive in such a way that it looks like a JAR file with the classes unique to that archive.</p> 
  </div> 
  <div class="paragraph"> 
   <p>For example in the case of WAR files, such jar extractor should serve the classes from <code>WEB-INF/classes</code> but not the contents of the libraries from <code>WEB-INF/lib</code>, which is meant to contain the dependencies of the main classes. Revapi assumes that the dependencies of the main archive are supplied separately and thus it assumes that it already has access to the equivalents of the jars from <code>WEB-INF/lib</code>. What it does not know is how to extract "significant" classes from the WAR file itself that are not contained anywhere else.</p> 
  </div> 
  <div class="paragraph"> 
   <p>Well, actually, the above is a bit of a lie. <code>revapi-java</code> contains a default <code>JarExtractor</code> for handling WAR files already :)</p> 
  </div> 
 </div> 
</div>
			</div>
		</div>
		<div class="col-md-4">
			<div id="toc-sidebar">
				<div class="well">
					<ul class="nav nav-list">
						<li class="nav-header">Table of Contents</li>
		<li><a href="#revapi_java_spi" title="Revapi Java SPI">Revapi Java SPI</a>
		<li class="dropdown"><a href="#enhancing_java_api_checks" title="Enhancing Java API checks">Enhancing Java API checks <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#project_setup" title="Project setup">Project setup</a>
		<li><a href="#code" title="Code">Code</a>
		<li><a href="#usage" title="Usage">Usage</a>
			</ul>
		</li>
		<li><a href="#handling_new_packaging_of_code" title="Handling new packaging of code">Handling new packaging of code</a>
					</ul>
				</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->

	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="col-md-3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Basic Info</li>
						<li >
							<a href="../../architecture.html" title="Architecture">Architecture</a>
						</li>
						<li >
							<a href="../../configuration.html" title="Configuration">Configuration</a>
						</li>
						<li >
							<a href="../../building.html" title="Building">Building</a>
						</li>
						<li >
							<a href="../../extensions.html" title="Extensions">Extensions</a>
						</li>
						<li class="nav-header">Sub Projects</li>
						<li >
							<a href="../revapi/index.html" title="Revapi API">Revapi API</a>
						</li>
						<li >
							<a href="../revapi-ant-task/index.html" title="Ant Task">Ant Task</a>
						</li>
						<li >
							<a href="../revapi-basic-features/index.html" title="Basic Features">Basic Features</a>
						</li>
						<li >
							<a href="../revapi-java/index.html" title="Java Extension">Java Extension</a>
						</li>
						<li class="active">
							<a href="#" title="Java Extension SPI">Java Extension SPI</a>
						</li>
						<li >
							<a href="https://github.com/revapi/testjars" title="Java Test Support" class="externalLink">Java Test Support</a>
						</li>
						<li >
							<a href="../revapi-reporter-text/index.html" title="Text Report Extension">Text Report Extension</a>
						</li>
						<li >
							<a href="../revapi-maven-plugin/index.html" title="Maven Plugin">Maven Plugin</a>
						</li>
					</ul>
				</div>
				<div class="col-md-3 bottom-nav">
					<ul class="nav nav-list">
					</ul>
				</div>
				<div class="col-md-3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Maven Documentation</li>
						<li >
							<a href="project-info.html" title="Project Information">Project Information <i class="glyphicon glyphicon-chevron-down"></i></a>
							<ul class="nav nav-list">
						<li class="active">
							<a href="#" title="About">About</a>
						</li>
						<li >
							<a href="license.html" title="Project License">Project License</a>
						</li>
						<li >
							<a href="mail-lists.html" title="Mailing Lists">Mailing Lists</a>
						</li>
						<li >
							<a href="issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
						</li>
						<li >
							<a href="source-repository.html" title="Source Repository">Source Repository</a>
						</li>
						<li >
							<a href="team-list.html" title="Project Team">Project Team</a>
						</li>
						<li >
							<a href="integration.html" title="Continuous Integration">Continuous Integration</a>
						</li>
							</ul>
						</li>
						<li >
							<a href="project-reports.html" title="Project Reports">Project Reports <i class="glyphicon glyphicon-chevron-right"></i></a>
						</li>
					</ul>
				</div>
				<div class="col-md-3 bottom-description">
					<blockquote>Revapi Java SPI</blockquote>
					<blockquote class="version-date"><span class="projectVersion">Version: 0.18.1</span><br/><span class="publishDate">Last Published: 2019-05-06</span></blockquote>
				</div>
			</div>
		</div>
	</footer>

	<div class="container subfooter">
		<div class="row">
			<div class="col-md-12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014-2019 <a href="http://lukas.krejci.pw">Lukas Krejci</a>. All Rights Reserved.</p>
				<p><a href="http://github.com/tunguski/msb3-maven-skin" title="Msb3 Maven skin">Msb3 Maven skin</a> by <a href="http://matsuo.pl" target="_blank" title="Marek Romanowski">Marek Romanowski</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.min.js"></script>
	<script src="./js/msb3-scroll.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>
	
<script async="true" src="//revapi-org.disqus.com/count.js" id="dsq-count-scr"></script>
	<script src="./js/msb3-skin.js"></script>

	</body>
</html>